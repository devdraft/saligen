name: Generate SDKs

on:
  push:
    branches:
      - main
    paths:
      - 'sdk/openapi.yaml'
      - 'sdk/configs/**'
      - 'sdk/wrappers/**'
      - 'sdk/generate.sh'
      - '.github/workflows/sdk-generate.yml'
    tags:
      - 'sdk-*@*'
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to generate (comma-separated or "all")'
        required: false
        default: 'all'
      publish:
        description: 'Publish SDKs to package registries'
        required: false
        type: boolean
        default: false

jobs:
  validate-openapi:
    name: Validate OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate OpenAPI spec
        uses: char0n/swagger-editor-validate@v1
        with:
          swagger-editor-url: https://editor.swagger.io
          definition-file: sdk/openapi.yaml

  generate-typescript:
    name: Generate TypeScript SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate TypeScript SDK
        run: ./sdk/generate.sh -l typescript
      
      - name: Build TypeScript SDK
        run: |
          cd sdk/wrappers/typescript
          npm install
          npm run build
      
      - name: Upload TypeScript SDK
        uses: actions/upload-artifact@v4
        with:
          name: typescript-sdk
          path: sdk/generated/typescript
      
      - name: Publish to npm
        if: startsWith(github.ref, 'refs/tags/sdk-ts@') || (github.event_name == 'workflow_dispatch' && inputs.publish)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd sdk/generated/typescript
          npm publish --access public

  generate-python:
    name: Generate Python SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Python SDK
        run: ./sdk/generate.sh -l python
      
      - name: Build Python SDK
        run: |
          cd sdk/wrappers/python
          python -m pip install --upgrade pip build
          python -m build
      
      - name: Upload Python SDK
        uses: actions/upload-artifact@v4
        with:
          name: python-sdk
          path: sdk/generated/python
      
      - name: Publish to PyPI
        if: startsWith(github.ref, 'refs/tags/sdk-py@') || (github.event_name == 'workflow_dispatch' && inputs.publish)
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          python -m pip install twine
          cd sdk/generated/python
          twine upload dist/*

  generate-go:
    name: Generate Go SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Go SDK
        run: ./sdk/generate.sh -l go
      
      - name: Build and Test Go SDK
        run: |
          cd sdk/generated/go
          go mod tidy
          go build ./...
          go vet ./...
      
      - name: Upload Go SDK
        uses: actions/upload-artifact@v4
        with:
          name: go-sdk
          path: sdk/generated/go

  generate-php:
    name: Generate PHP SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate PHP SDK
        run: ./sdk/generate.sh -l php
      
      - name: Install Composer dependencies
        run: |
          cd sdk/wrappers/php
          composer install --no-dev --optimize-autoloader
      
      - name: Upload PHP SDK
        uses: actions/upload-artifact@v4
        with:
          name: php-sdk
          path: sdk/generated/php

  generate-rust:
    name: Generate Rust SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Rust SDK
        run: ./sdk/generate.sh -l rust
      
      - name: Build Rust SDK
        run: |
          cd sdk/wrappers/rust
          cargo build --release
      
      - name: Upload Rust SDK
        uses: actions/upload-artifact@v4
        with:
          name: rust-sdk
          path: sdk/generated/rust
      
      - name: Publish to crates.io
        if: startsWith(github.ref, 'refs/tags/sdk-rust@') || (github.event_name == 'workflow_dispatch' && inputs.publish)
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_TOKEN }}
        run: |
          cd sdk/generated/rust
          cargo publish

  generate-swift:
    name: Generate Swift SDK
    needs: validate-openapi
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Swift SDK
        run: ./sdk/generate.sh -l swift
      
      - name: Build Swift SDK
        run: |
          cd sdk/wrappers/swift
          swift build
      
      - name: Upload Swift SDK
        uses: actions/upload-artifact@v4
        with:
          name: swift-sdk
          path: sdk/generated/swift

  generate-ruby:
    name: Generate Ruby SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Ruby SDK
        run: ./sdk/generate.sh -l ruby
      
      - name: Build Ruby Gem
        run: |
          cd sdk/wrappers/ruby
          gem build yourapi.gemspec
      
      - name: Upload Ruby SDK
        uses: actions/upload-artifact@v4
        with:
          name: ruby-sdk
          path: sdk/generated/ruby
      
      - name: Publish to RubyGems
        if: startsWith(github.ref, 'refs/tags/sdk-ruby@') || (github.event_name == 'workflow_dispatch' && inputs.publish)
        env:
          RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_TOKEN }}
        run: |
          cd sdk/wrappers/ruby
          gem push *.gem

  generate-java:
    name: Generate Java SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Java SDK
        run: ./sdk/generate.sh -l java
      
      - name: Build Java SDK with Maven
        run: |
          cd sdk/wrappers/java
          mvn clean package
      
      - name: Upload Java SDK
        uses: actions/upload-artifact@v4
        with:
          name: java-sdk
          path: sdk/generated/java
      
      - name: Publish to Maven Central
        if: startsWith(github.ref, 'refs/tags/sdk-java@') || (github.event_name == 'workflow_dispatch' && inputs.publish)
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd sdk/wrappers/java
          mvn deploy -P release

  generate-kotlin:
    name: Generate Kotlin SDK
    needs: validate-openapi
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Install OpenAPI Generator
        run: npm install -g @openapitools/openapi-generator-cli
      
      - name: Generate Kotlin SDK
        run: ./sdk/generate.sh -l kotlin
      
      - name: Build Kotlin SDK with Gradle
        run: |
          cd sdk/wrappers/kotlin
          ./gradlew build
      
      - name: Upload Kotlin SDK
        uses: actions/upload-artifact@v4
        with:
          name: kotlin-sdk
          path: sdk/generated/kotlin
      
      - name: Publish to Maven Central
        if: startsWith(github.ref, 'refs/tags/sdk-kotlin@') || (github.event_name == 'workflow_dispatch' && inputs.publish)
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd sdk/wrappers/kotlin
          ./gradlew publish

  summary:
    name: Generation Summary
    needs:
      - generate-typescript
      - generate-python
      - generate-go
      - generate-php
      - generate-rust
      - generate-swift
      - generate-ruby
      - generate-java
      - generate-kotlin
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All SDKs generated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated SDKs:" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript" >> $GITHUB_STEP_SUMMARY
          echo "- Python" >> $GITHUB_STEP_SUMMARY
          echo "- Go" >> $GITHUB_STEP_SUMMARY
          echo "- PHP" >> $GITHUB_STEP_SUMMARY
          echo "- Rust" >> $GITHUB_STEP_SUMMARY
          echo "- Swift" >> $GITHUB_STEP_SUMMARY
          echo "- Ruby" >> $GITHUB_STEP_SUMMARY
          echo "- Java" >> $GITHUB_STEP_SUMMARY
          echo "- Kotlin" >> $GITHUB_STEP_SUMMARY

